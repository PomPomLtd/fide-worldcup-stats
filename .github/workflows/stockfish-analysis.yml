name: üî¨ Stockfish Analysis
run-name: üî¨ Stockfish ${{ inputs.round && format('Round {0}', inputs.round) || 'All Rounds' }} (depth ${{ inputs.depth || 15 }})

on:
  workflow_dispatch:
    inputs:
      round:
        description: 'Round number (1-6, or leave empty for all rounds)'
        required: false
        type: string
      depth:
        description: 'Stockfish depth (default: 15)'
        required: false
        default: '15'
        type: number

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 240  # 4 hours maximum for full tournament analysis

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Stockfish
        run: |
          sudo apt-get update
          sudo apt-get install -y stockfish
          stockfish --version

      - name: Install Python dependencies
        run: |
          pip3 install -r requirements.txt

      - name: Create analysis directory
        run: |
          mkdir -p data/analysis

      - name: Determine analysis scope
        id: scope
        run: |
          if [ -z "${{ github.event.inputs.round }}" ]; then
            echo "scope=all" >> $GITHUB_OUTPUT
            echo "rounds=1 2 3 4 5 6" >> $GITHUB_OUTPUT
            echo "Will analyze ALL rounds (1-6)"
          else
            echo "scope=single" >> $GITHUB_OUTPUT
            echo "rounds=${{ github.event.inputs.round }}" >> $GITHUB_OUTPUT
            echo "Will analyze Round ${{ github.event.inputs.round }}"
          fi

      - name: Run Stockfish Analysis
        run: |
          echo "Starting Stockfish analysis"
          echo "Depth: ${{ github.event.inputs.depth }}"
          echo "Rounds: ${{ steps.scope.outputs.rounds }}"
          echo "Start time: $(date)"
          echo ""

          for round in ${{ steps.scope.outputs.rounds }}; do
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üî¨ Analyzing Round $round"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Find all PGN files for this round
            pgn_files=$(find _SRC/cup2025 -name "games.pgn" -path "*round${round}game*" | sort)

            if [ -z "$pgn_files" ]; then
              echo "‚ö†Ô∏è  No PGN files found for Round $round"
              continue
            fi

            file_count=$(echo "$pgn_files" | wc -l)
            echo "üìÇ Found $file_count PGN file(s) for Round $round"

            # Concatenate all PGN files for this round
            echo "üì• Concatenating PGN files..."
            cat $pgn_files > "/tmp/round-${round}-all.pgn"

            # Count games
            game_count=$(grep -c '^\[Event ' "/tmp/round-${round}-all.pgn" || echo "0")
            echo "‚ôüÔ∏è  Total games: $game_count"
            echo ""

            # Run Stockfish analysis
            echo "üöÄ Running Stockfish (depth ${{ github.event.inputs.depth }})..."
            cat "/tmp/round-${round}-all.pgn" | \
              python3 scripts/analyze-pgn.py --depth ${{ github.event.inputs.depth }} \
              > "data/analysis/round-${round}-analysis.json"

            # Check output
            if [ -f "data/analysis/round-${round}-analysis.json" ]; then
              size=$(du -h "data/analysis/round-${round}-analysis.json" | cut -f1)
              echo "‚úÖ Analysis complete: round-${round}-analysis.json ($size)"
            else
              echo "‚ùå Analysis failed for Round $round"
            fi

            echo ""
          done

          echo "End time: $(date)"

      - name: Verify output
        run: |
          echo "üìä Analysis Results:"
          echo ""
          ls -lh data/analysis/ || echo "No analysis files generated"
          echo ""

          # Show summary for each round
          for file in data/analysis/round-*-analysis.json; do
            if [ -f "$file" ]; then
              round=$(basename "$file" | grep -oP 'round-\K\d+')
              games=$(cat "$file" | grep -o '"gameIndex"' | wc -l)
              echo "Round $round: $games games analyzed"
            fi
          done

      - name: Commit and push results
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add data/analysis/*.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "${{ steps.scope.outputs.scope }}" = "all" ]; then
              git commit -m "$(cat <<'EOF'
          Add Stockfish analysis for all rounds

          Generated by GitHub Actions
          EOF
          )"
            else
              git commit -m "$(cat <<'EOF'
          Add Stockfish analysis for Round ${{ github.event.inputs.round }}

          Analyzed with depth ${{ github.event.inputs.depth }}
          Generated by GitHub Actions
          EOF
          )"
            fi
            git pull --rebase
            git push
          fi

      - name: Summary
        if: always()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Analysis Summary"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          if [ "${{ steps.scope.outputs.scope }}" = "all" ]; then
            echo "Scope: All available rounds"
          else
            echo "Scope: Round ${{ github.event.inputs.round }}"
          fi
          echo "Depth: ${{ github.event.inputs.depth }}"
          echo ""

          if [ -d "data/analysis" ]; then
            file_count=$(ls -1 data/analysis/round-*-analysis.json 2>/dev/null | wc -l)
            echo "Files generated: $file_count"

            total_size=$(du -sh data/analysis 2>/dev/null | cut -f1 || echo "0")
            echo "Total size: $total_size"
          else
            echo "No analysis files generated"
          fi
