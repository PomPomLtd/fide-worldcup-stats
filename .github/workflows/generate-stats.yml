name: üìä Generate Tournament Statistics
run-name: üìä Generate Stats

on:
  workflow_dispatch:
    inputs:
      skip_stockfish:
        description: 'Skip Stockfish analysis (use separate parallel workflow for faster analysis)'
        required: false
        default: true
        type: boolean
      depth:
        description: 'Stockfish depth (default: 15, only used if skip_stockfish=false)'
        required: false
        default: '15'
        type: number

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: ${{ inputs.skip_stockfish && 30 || 300 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Setup Python (for optional Stockfish analysis)
        if: ${{ !inputs.skip_stockfish }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Stockfish
        if: ${{ !inputs.skip_stockfish }}
        run: |
          sudo apt-get update
          sudo apt-get install -y stockfish
          stockfish --version

      - name: Install Python dependencies
        if: ${{ !inputs.skip_stockfish }}
        run: |
          pip3 install -r requirements.txt

      - name: Download and extract PGN files
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì• Downloading FIDE World Cup 2025 PGN data"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          curl -L https://worldcup2025.fide.com/files/cup2025.zip -o /tmp/cup2025.zip
          echo "üì¶ Extracting PGN files..."
          mkdir -p _SRC/cup2025
          unzip -q /tmp/cup2025.zip -d _SRC/cup2025/
          echo "‚úÖ PGN files ready ($(find _SRC/cup2025 -name '*.pgn' | wc -l) files)"
          echo ""

      - name: Generate Statistics
        run: |
          echo "Starting statistics generation..."
          echo "Start time: $(date)"

          # Stage 1: Consolidate PGN files by match
          echo "üì¶ Stage 1: Consolidating PGN files..."
          npm run consolidate

          # Stage 2: Classify games by time control
          echo "üè∑Ô∏è  Stage 2: Classifying games by time control..."
          npm run classify

          # Stage 3: Enrich with opening names
          echo "üìö Stage 3: Enriching with opening names..."
          npm run enrich

          # Stage 4: Generate statistics
          echo "üìä Stage 4: Generating statistics..."
          npm run generate:stats

          echo "End time: $(date)"

      - name: Run Stockfish Analysis
        if: ${{ !inputs.skip_stockfish }}
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üî¨ Stage 5: Running Stockfish analysis"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚ÑπÔ∏è  For faster parallel analysis, use the 'Stockfish Analysis (Parallel)' workflow"
          echo ""
          mkdir -p data/analysis

          for round in {1..6}; do
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üî¨ Analyzing Round $round"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            pgn_files=$(find _SRC/cup2025 -name "games.pgn" -path "*round${round}game*" | sort)

            if [ -z "$pgn_files" ]; then
              echo "‚ö†Ô∏è  No PGN files found for Round $round"
              continue
            fi

            game_count=$(cat $pgn_files | grep -c '^\[Event ' || echo "0")
            echo "‚ôüÔ∏è  Total games: $game_count"
            echo ""

            cat $pgn_files | python3 -u scripts/analyze-pgn.py --depth ${{ inputs.depth }} \
              > "data/analysis/round-${round}-analysis.json" || true

            echo ""
            if [ -f "data/analysis/round-${round}-analysis.json" ]; then
              size=$(du -h "data/analysis/round-${round}-analysis.json" | cut -f1)
              echo "‚úÖ Analysis complete: round-${round}-analysis.json ($size)"
            else
              echo "‚ùå Analysis failed for Round $round"
            fi
            echo ""
          done

      - name: Generate Tournament Overview
        run: |
          echo "üèÜ Stage 6: Generating tournament overview..."
          npm run generate:overview

      - name: Verify output
        run: |
          echo "Checking generated files..."
          ls -lh public/stats/

          echo ""
          echo "Tournament Overview Summary:"
          if [ -f "public/stats/tournament-overview.json" ]; then
            jq -r '"Total Games: \(.totalGames) | Rounds: \(.totalRounds) | Completed: \(.roundsCompleted)"' public/stats/tournament-overview.json
          fi

      - name: Commit and push results
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add public/stats/*.json
          git add data/consolidated/*.json
          git add data/classified/*.json
          git add data/enriched/*.json

          # Add analysis files if Stockfish was run
          if [ -d "data/analysis" ] && [ "$(ls -A data/analysis 2>/dev/null)" ]; then
            git add data/analysis/*.json
          fi

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "${{ inputs.skip_stockfish }}" = "false" ]; then
              msg="Update tournament statistics (with Stockfish depth ${{ inputs.depth }})"
            else
              msg="Update tournament statistics"
            fi

            git commit -m "$msg

          Generated by GitHub Actions"
            git pull --rebase
            git push
          fi

      - name: Summary
        if: always()
        run: |
          if [ -f "public/stats/tournament-overview.json" ]; then
            echo "‚úÖ Statistics generated successfully!"
            echo ""
            echo "üìä Overview:"
            jq -r '"  Games: \(.totalGames)\n  Matches: \(.totalMatches)\n  Moves: \(.totalMoves)\n  Rounds Complete: \(.roundsCompleted)/\(.totalRounds)"' public/stats/tournament-overview.json
          else
            echo "‚ùå Failed to generate statistics"
          fi
