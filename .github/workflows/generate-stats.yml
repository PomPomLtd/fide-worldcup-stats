name: Generate Tournament Statistics

on:
  push:
    branches:
      - main
    paths:
      - '_SRC/cup2025/**'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      skip_stockfish:
        description: 'Skip Stockfish analysis (faster)'
        required: false
        default: true
        type: boolean

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Setup Python (for optional Stockfish analysis)
        if: ${{ !inputs.skip_stockfish }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Stockfish
        if: ${{ !inputs.skip_stockfish }}
        run: |
          sudo apt-get update
          sudo apt-get install -y stockfish
          stockfish --version

      - name: Install Python dependencies
        if: ${{ !inputs.skip_stockfish }}
        run: |
          pip3 install -r requirements.txt

      - name: Generate Statistics
        run: |
          echo "Starting statistics generation..."
          echo "Start time: $(date)"

          # Stage 1: Consolidate PGN files by match
          echo "üì¶ Stage 1: Consolidating PGN files..."
          npm run consolidate

          # Stage 2: Classify games by time control
          echo "üè∑Ô∏è  Stage 2: Classifying games by time control..."
          npm run classify

          # Stage 3: Enrich with opening names
          echo "üìö Stage 3: Enriching with opening names..."
          npm run enrich

          # Stage 4: Generate statistics
          echo "üìä Stage 4: Generating statistics..."
          npm run generate:stats

          echo "End time: $(date)"

      - name: Run Stockfish Analysis
        if: ${{ !inputs.skip_stockfish }}
        run: |
          echo "üî¨ Stage 5: Running Stockfish analysis (optional)..."
          echo "This may take a while..."
          npm run analyze

      - name: Generate Tournament Overview
        run: |
          echo "üèÜ Stage 6: Generating tournament overview..."
          npm run generate:overview

      - name: Verify output
        run: |
          echo "Checking generated files..."
          ls -lh public/stats/

          echo ""
          echo "Tournament Overview Summary:"
          if [ -f "public/stats/tournament-overview.json" ]; then
            jq -r '"Total Games: \(.totalGames) | Rounds: \(.totalRounds) | Completed: \(.roundsCompleted)"' public/stats/tournament-overview.json
          fi

      - name: Commit and push results
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add public/stats/*.json
          git add data/consolidated/*.json
          git add data/classified/*.json
          git add data/enriched/*.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            ANALYSIS_NOTE=""
            if [ "${{ inputs.skip_stockfish }}" != "true" ]; then
              ANALYSIS_NOTE=" with Stockfish analysis"
            fi

            git commit -m "Update tournament statistics$ANALYSIS_NOTE

Generated by GitHub Actions
Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

            git pull --rebase
            git push
          fi

      - name: Summary
        if: always()
        run: |
          if [ -f "public/stats/tournament-overview.json" ]; then
            echo "‚úÖ Statistics generated successfully!"
            echo ""
            echo "üìä Overview:"
            jq -r '"  Games: \(.totalGames)\n  Matches: \(.totalMatches)\n  Moves: \(.totalMoves)\n  Rounds Complete: \(.roundsCompleted)/\(.totalRounds)"' public/stats/tournament-overview.json
          else
            echo "‚ùå Failed to generate statistics"
          fi
